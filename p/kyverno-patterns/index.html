<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Kyverno is an admission controller used to add policies to your cluster. The basic principle of an admission controller is to intercept incoming requests to a given kubernetes api server and check if a field matches an expression, then approve or deny the request based on that determination. If you&amp;rsquo;re not familiar with admission controllers already, I&amp;rsquo;d recommend reading the official documentation.
If you&amp;rsquo;re in the process of deciding what admisson controller to use in your environment, consider the background of the team that will be maintaining the policies."><title>Good Kyverno Admission Control Patterns</title><link rel=canonical href=https://salinesel.in/p/kyverno-patterns/><link rel=stylesheet href=/scss/style.min.fe253589db5a54c99fe6b16bfbaf0243d856d34f8c07f3534613b39ed043b738.css><meta property="og:title" content="Good Kyverno Admission Control Patterns"><meta property="og:description" content="Kyverno is an admission controller used to add policies to your cluster. The basic principle of an admission controller is to intercept incoming requests to a given kubernetes api server and check if a field matches an expression, then approve or deny the request based on that determination. If you&amp;rsquo;re not familiar with admission controllers already, I&amp;rsquo;d recommend reading the official documentation.
If you&amp;rsquo;re in the process of deciding what admisson controller to use in your environment, consider the background of the team that will be maintaining the policies."><meta property="og:url" content="https://salinesel.in/p/kyverno-patterns/"><meta property="og:site_name" content="Saline Selin"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="kubernetes"><meta property="article:published_time" content="2022-07-12T16:12:18-06:00"><meta property="article:modified_time" content="2022-07-12T16:12:18-06:00"><meta property="og:image" content="https://salinesel.in/p/kyverno-patterns/pexels-photo-1169754.jpeg"><meta name=twitter:title content="Good Kyverno Admission Control Patterns"><meta name=twitter:description content="Kyverno is an admission controller used to add policies to your cluster. The basic principle of an admission controller is to intercept incoming requests to a given kubernetes api server and check if a field matches an expression, then approve or deny the request based on that determination. If you&amp;rsquo;re not familiar with admission controllers already, I&amp;rsquo;d recommend reading the official documentation.
If you&amp;rsquo;re in the process of deciding what admisson controller to use in your environment, consider the background of the team that will be maintaining the policies."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://salinesel.in/p/kyverno-patterns/pexels-photo-1169754.jpeg"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"dark")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src="https://avatars.githubusercontent.com/u/47022783?v=4" width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Saline Selin</a></h1><h2 class=site-description>Another blog for devops things</h2></div></header><ol class=social-menu><li><a href=https://github.com/salineselin target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://salinesel.in/index.xml target=_blank title=RSS><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/kyverno-patterns/><img src=/p/kyverno-patterns/pexels-photo-1169754_hu6a769397f95e7a3716819b6b994b529b_2453190_800x0_resize_q75_box.jpeg srcset="/p/kyverno-patterns/pexels-photo-1169754_hu6a769397f95e7a3716819b6b994b529b_2453190_800x0_resize_q75_box.jpeg 800w, /p/kyverno-patterns/pexels-photo-1169754_hu6a769397f95e7a3716819b6b994b529b_2453190_1600x0_resize_q75_box.jpeg 1600w" width=800 height=534 loading=lazy alt="Featured image of post Good Kyverno Admission Control Patterns"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/kyverno-patterns/>Good Kyverno Admission Control Patterns</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jul 12, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>8 minute read</time></div></footer></div></header><section class=article-content><p>Kyverno is an admission controller used to add policies to your cluster. The basic principle of an admission controller is to intercept incoming requests to a given kubernetes api server and check if a field matches an expression, then approve or deny the request based on that determination. If you&rsquo;re not familiar with admission controllers already, I&rsquo;d recommend reading <a class=link href=https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-are-they target=_blank rel=noopener>the official documentation</a>.</p><p>If you&rsquo;re in the process of deciding what admisson controller to use in your environment, consider the background of the team that will be maintaining the policies. Do they all know how to program in Golang? If so, <a class=link href=https://github.com/open-policy-agent/gatekeeper target=_blank rel=noopener>OPA Gatekeeper</a> may be a better choice for you. I personally believe that Kyverno is a better admission controller because the barrier for reading and writing policies is significantly lower than OPA. I haven&rsquo;t run into a scenario where I need more verbose or complex syntax beyond what ships in Kyverno by default.</p><h2 id=the-gist>THE GIST</h2><ul><li>Have some way to whitelist resources</li><li>Make all your transformations with JSON patches</li><li>Narrow down the scope of your whitelists as much as possible</li><li>Configure all policies to accept an array of rules rather than a single ruleset</li><li>Have some way to unit test against admission controller policies when working with k8s manifests in a github repository</li><li>Separate your Kyverno installation from the underlying policies</li><li>Have some way to toggle rule actions between audit and enforcement</li><li>Add remote policies using raw.githubusercontent.com rather than copying them locally</li><li>When referencing remote policies, target a commit hash or branch version rather than the main branch&rsquo;s head</li><li>Avoid mutating resources with policies when possible</li></ul><h2 id=example>EXAMPLE</h2><p>I created this example github repository that illustrates all of the principles in this article
<a class=link href=https://github.com/salineselin/kyverno-example target=_blank rel=noopener>https://github.com/salineselin/kyverno-example</a></p><h2 id=recommendations>RECOMMENDATIONS</h2><p>The following sections expand on the gists described earlier</p><h3 id=have-some-way-to-whitelist-resources>Have some way to whitelist resources</h3><p>It is inevitable that you will have resources in your kubernetes clusters that violate policies. Defining some generic templatized process around how you add exceptions to a whitelist is crucial. You can whitelist resources by using the <code>exclude</code> key like so:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kyverno.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>disallow-capabilities</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>validationFailureAction</span><span class=p>:</span><span class=w> </span><span class=l>audit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>background</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>adding-capabilities</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exclude</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>any</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>kinds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>managed-prometheus-collector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>any</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>kinds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>validate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=p>&gt;-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          Any capabilities added beyond the allowed list (AUDIT_WRITE, CHOWN, DAC_OVERRIDE, FOWNER,
</span></span></span><span class=line><span class=cl><span class=sd>          FSETID, KILL, MKNOD, NET_BIND_SERVICE, SETFCAP, SETGID, SETPCAP, SETUID, SYS_CHROOT)
</span></span></span><span class=line><span class=cl><span class=sd>          are disallowed.</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>deny</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>all</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ request.object.spec.[ephemeralContainers, initContainers, containers][].securityContext.capabilities.add[] }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>AnyNotIn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>value</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span>- <span class=l>SYS_CHROOT</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=make-all-your-changes-with-json-patches>Make all your changes with JSON patches</h3><p>This applies if you&rsquo;re using Kustomize to manage your Kyverno transformations. Kustomize overlays are excellent at implicitly overlaying all the necessary parameters, but when you start working with array indexes more, you start wiping data that you don&rsquo;t intend to and you usually end up repeating yourself a lot. If you make all your transformations with JSON patches rather than overlays, you have a complete list of all your transformations, and debugging those transformations becomes a lot easier when kustomize executes and can explicitly point out a faulty JSON patch.</p><h3 id=narrow-down-the-scope-of-your-whitelists-as-much-as-possible>Narrow down the scope of your whitelists as much as possible</h3><p>Whitelisting a namespace is a very primitive control for adding exceptions for entities. It&rsquo;s fast and easy to understand, but is grossly overpermissive. Unless you have your RBAC hardened to a point where clusters users don&rsquo;t have visibility into what the policy exceptions are, its trivial for an attacker to just use a different namespace that&rsquo;s been whitelisted.</p><h3 id=configure-all-policies-to-accept-an-array-of-rules-rather-than-a-single-ruleset>Configure all policies to accept an array of rules rather than a single ruleset</h3><p>There are multiple valid syntaxes when defining a policy. You can match according to one object or an array of objects. The preferred method is an array of objects. It&rsquo;s not mentioned in Kyverno&rsquo;s documentation, but if you use an <code>any</code> match selector, you also have to use the <code>any</code> selector when creating exclusions. To demonstrate why you want to only work with an array of matches rather than a single defined match, let&rsquo;s work with the following policy:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kyverno.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>disallow-capabilities</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>validationFailureAction</span><span class=p>:</span><span class=w> </span><span class=l>audit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>background</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>adding-capabilities</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>kinds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>validate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=p>&gt;-</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          Any capabilities added beyond the allowed list (AUDIT_WRITE, CHOWN, DAC_OVERRIDE, FOWNER,
</span></span></span><span class=line><span class=cl><span class=sd>          FSETID, KILL, MKNOD, NET_BIND_SERVICE, SETFCAP, SETGID, SETPCAP, SETUID, SYS_CHROOT)
</span></span></span><span class=line><span class=cl><span class=sd>          are disallowed.</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>deny</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>conditions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>all</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ request.object.spec.[ephemeralContainers, initContainers, containers][].securityContext.capabilities.add[] }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>AnyNotIn</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>value</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span>- <span class=l>SYS_CHROOT</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>This policy which you can find in source <a class=link href=https://github.com/kyverno/policies/blob/main/pod-security/baseline/disallow-capabilities/disallow-capabilities.yaml target=_blank rel=noopener>here</a> is perfectly valid. The problem is when you want to whitelist a particular namespace or add another ruleset with more advanced targeting, you have to heavily modify the underlying ruleset with JSON patches.</p><p>Let&rsquo;s say I wanted to add two exceptions according to a label selector. Instead of a single JSON patch that looks something like the following, you would have to add multiple patches to get your policy into your defined state. Transformations are necessary, but excessive transformations mean you have more code to maintain, and legibility is decreased.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>op</span><span class=p>:</span><span class=w> </span><span class=l>add</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/spec/rules/0/exclude</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>any</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>kinds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=c># gke&#39;s managed prometheus uses the host ports</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>managed-prometheus-collector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>kinds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=c># gke&#39;s managed prometheus rule evaluator needs them as well</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>rule-evaluator</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>This is the desirable syntax</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>any</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>kinds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>Pod</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>And this is the less-than-desirable syntax</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kinds</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>Pod</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Almost all of the policies you find today in the <a class=link href=https://github.com/kyverno/policies target=_blank rel=noopener>public Kyverno policies repository</a> now use the array syntax by default, but it wasn&rsquo;t always that way. In <a class=link href=https://github.com/kyverno/policies/commit/944498575e423eb98d4b31f6ae69e1e8161004c6#diff-77b3af0188557903b284d66fac9ef6be3532b5474ec9382c28f1ec8388f832d1 target=_blank rel=noopener>this earlier commit</a> you can find remnants of when the configured rules did not use the array syntax.</p><h3 id=have-some-way-to-unit-test-against-admission-controller-policies-when-working-with-k8s-manifests-in-a-github-repository>Have some way to unit test against admission controller policies when working with k8s manifests in a github repository</h3><p>Debugging CI sucks. If your CI|CD pipeline is verbose and takes five minutes to deploy something to a cluster, but it fails due to a failed policy check, it chisels at your soul. Feedback loops become repetitive, slow, and unfruitful. If you&rsquo;re using a CI provider like Github Actions, make a pipeline that runs a unit test using <code>kubectl apply -f /path/to/yaml --dry-run=server</code>. If this method is unpalatable for your use-case, it&rsquo;s worth looking into tools like <a class=link href=https://datree.io/ target=_blank rel=noopener>Datree</a> that offer admission controller unit testing. I personally don&rsquo;t use Datree because until they ship their own admission controller, there will always be a lack of parity between the policies Datree provides and the policies you provide in Kyverno.</p><p>If that isn&rsquo;t soon enough and you&rsquo;re still experiencing pain with iteration, you could potentially use a git hook when you push source control changes to remote (similar to how <a class=link href=https://www.npmjs.com/package/husky target=_blank rel=noopener>husky</a> does it) to get that feedback even sooner. I&rsquo;d recommend only implementing a hook like this if the developers working on kubernetes manifests are acclimated to kubernetes and have their policies pulled down into their local dev cluster, or they&rsquo;re authenticated into a remote cluster with a context they can use to <code>--dry-run=server</code> against.</p><p>Most of the manifests you write are likely written and then rarely touched, so iteration slow and frequent enough to cause admission controller heartache is likely seldom.</p><h3 id=separate-your-kyverno-installation-from-the-underlying-policies>Separate your Kyverno installation from the underlying policies</h3><p>Respect that the policies you install are separate from the application that enforces the policies. They have divergent lifecycles, but should be respected as harmonious companions</p><h3 id=have-some-way-to-toggle-rule-actions-between-audit-and-enforcement>Have some way to toggle rule actions between audit and enforcement</h3><p>If you&rsquo;re working with remote policies a lot, most of them are usually set to <code>audit</code> rather than <code>enforce</code>, so you&rsquo;ll need to make a transformation that changes the <code>validationFailureAction</code> value. I use this JSON patch:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>op</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/spec/validationFailureAction</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>enforce</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=add-remote-policies-using-rawgithubusercontentcom-rather-than-copying-them-locally>Add remote policies using raw.githubusercontent.com rather than copying them locally</h3><p>Kustomize allows you to target local as well as remote resources too! Make use of the <a class=link href=https://github.com/kyverno/policies target=_blank rel=noopener>Kyverno/policies</a> repository and use those instead of rewriting what&rsquo;s likely already been written. An example kustomize manifest that uses remote resources looks like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kustomize.config.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Kustomization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>commonLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kyverno</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># remote policies</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>https://raw.githubusercontent.com/kyverno/policies/release-1.7/pod-security/baseline/disallow-capabilities/disallow-capabilities.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>https://raw.githubusercontent.com/kyverno/policies/release-1.7/pod-security/baseline/disallow-host-namespaces/disallow-host-namespaces.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>https://raw.githubusercontent.com/kyverno/policies/release-1.7/pod-security/baseline/disallow-host-ports/disallow-host-ports.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>https://raw.githubusercontent.com/kyverno/policies/097ca254c5d52d05bf1aa385d140e8743b9f21ba/best-practices/disallow_default_namespace/disallow_default_namespace.yaml</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=when-referencing-remote-policies-target-a-commit-hash-or-branch-version-rather-than-the-main-branchs-head>When referencing remote policies, target a commit hash or branch version rather than the main branch&rsquo;s head</h3><p>In the previous example, you can see that explicit commit hashes are targeted rather than the latest and greatest. If you&rsquo;re using transformations, you&rsquo;ll likely have to stage the changes and update your patches on major updates.</p><h3 id=avoid-mutating-resources-with-policies-when-possible>Avoid mutating resources with policies when possible</h3><p>You can use an admission controller to <a class=link href=https://kyverno.io/docs/writing-policies/mutate/ target=_blank rel=noopener>mutate offending resources</a> rather than failing them outright. In my opinion this is something you should not do if you can avoid it. It is generally better to correct the resource manifest at its source rather than mutating it. Mutations are excellent for objects like logging sidecars and other container adjacent services.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/kubernetes/>kubernetes</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 Saline Selin</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.12.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#the-gist>THE GIST</a></li><li><a href=#example>EXAMPLE</a></li><li><a href=#recommendations>RECOMMENDATIONS</a><ol><li><a href=#have-some-way-to-whitelist-resources>Have some way to whitelist resources</a></li><li><a href=#make-all-your-changes-with-json-patches>Make all your changes with JSON patches</a></li><li><a href=#narrow-down-the-scope-of-your-whitelists-as-much-as-possible>Narrow down the scope of your whitelists as much as possible</a></li><li><a href=#configure-all-policies-to-accept-an-array-of-rules-rather-than-a-single-ruleset>Configure all policies to accept an array of rules rather than a single ruleset</a></li><li><a href=#have-some-way-to-unit-test-against-admission-controller-policies-when-working-with-k8s-manifests-in-a-github-repository>Have some way to unit test against admission controller policies when working with k8s manifests in a github repository</a></li><li><a href=#separate-your-kyverno-installation-from-the-underlying-policies>Separate your Kyverno installation from the underlying policies</a></li><li><a href=#have-some-way-to-toggle-rule-actions-between-audit-and-enforcement>Have some way to toggle rule actions between audit and enforcement</a></li><li><a href=#add-remote-policies-using-rawgithubusercontentcom-rather-than-copying-them-locally>Add remote policies using raw.githubusercontent.com rather than copying them locally</a></li><li><a href=#when-referencing-remote-policies-target-a-commit-hash-or-branch-version-rather-than-the-main-branchs-head>When referencing remote policies, target a commit hash or branch version rather than the main branch&rsquo;s head</a></li><li><a href=#avoid-mutating-resources-with-policies-when-possible>Avoid mutating resources with policies when possible</a></li></ol></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>